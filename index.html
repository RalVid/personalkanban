<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enkel Kanban</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --card: #111827;      /* gray-900 */
      --muted: #94a3b8;     /* slate-400 */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #22c55e;    /* green-500 */
      --accent-2: #3b82f6;  /* blue-500 */
      --danger: #ef4444;    /* red-500 */
      --border: #1f2937;    /* gray-800 */
      --shadow: 0 10px 20px rgba(0,0,0,.25);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% -10%, #1f2937 0%, var(--bg) 40%), var(--bg);
      color: var(--text);
    }
    header {
      max-width: 1100px; margin: 24px auto 8px; padding: 0 16px;
      display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;
    }
    header > div:first-child {
      flex: 1 1 auto;
      min-width: 0;
    }
    header > .controls {
      flex: 0 0 auto;
    }
    h1 { 
      font-size: 1.4rem; margin: 0; letter-spacing: .3px; cursor: pointer;
    }
    h1:hover { opacity: 0.8; }
    h1:hover + .edit-icon { opacity: 1; }
    .edit-icon {
      font-size: 1rem;
      opacity: 0.5;
      transition: opacity 0.2s;
      cursor: pointer;
    }
    .controls {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    }
    input[type="text"]{
      background: var(--card); border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; width: min(360px, 60vw);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.02);
    }
    button {
      border: 0; background: var(--accent); color: #051b0d; font-weight: 700;
      padding: 10px 14px; border-radius: 10px; cursor: pointer; box-shadow: var(--shadow);
      white-space: nowrap;
    }
    button.secondary { background: var(--accent-2); color: #0b1220; }
    button.ghost { background: transparent; color: var(--muted); box-shadow: none; border: 1px solid var(--border); }
    /* Hide export/import buttons - use menu instead */
    #exportBtn, #importBtn { display: none; }
    /* Hide menu - not needed with cloud sync */
    .mobile-menu { display: none; }
    .sync-status { display: flex; align-items: center; gap: 8px; font-size: .85rem; color: var(--muted); }
    .sync-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); }
    .sync-indicator.synced { background: var(--accent); }
    .sync-indicator.syncing { background: var(--accent-2); animation: pulse 1.5s infinite; }
    .sync-indicator.error { background: var(--danger); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .auth-section { display: flex; align-items: center; gap: 8px; }
    .user-info { display: flex; align-items: center; gap: 8px; font-size: .9rem; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; }
    
    /* Mobile menu */
    .mobile-menu {
      position: relative;
    }
    .menu-btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 8px;
    }
    .menu-btn:hover {
      background: var(--border);
    }
    .menu-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 4px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      min-width: 200px;
      z-index: 1000;
    }
    .menu-dropdown.show {
      display: block;
    }
    .menu-item {
      width: 100%;
      background: transparent;
      color: var(--text);
      border: none;
      padding: 12px 16px;
      text-align: left;
      cursor: pointer;
      border-radius: 0;
      box-shadow: none;
    }
    .menu-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    .menu-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    .menu-item:hover {
      background: var(--border);
    }

    main {
      max-width: 1100px; margin: 16px auto 40px; padding: 0 16px;
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
    }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }

    .column {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border: 1px solid var(--border); border-radius: var(--radius); min-height: 260px;
      display: flex; flex-direction: column; box-shadow: var(--shadow);
    }
    .col-header { display:flex; justify-content: space-between; align-items: center; padding: 14px 14px 8px; }
    .col-title { font-weight: 700; letter-spacing: .3px; }

    .dropzone {
      padding: 8px 10px 14px; flex: 1; border-radius: 0 0 var(--radius) var(--radius);
      outline: 2px dashed transparent; outline-offset: -6px;
      transition: outline-color .15s ease, background-color .15s ease;
    }
    .dropzone.dragover { outline-color: #3b82f6aa; background: rgba(59,130,246,0.07); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      padding: 10px 12px; margin: 8px 4px; box-shadow: var(--shadow);
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: start;
    }
    .card[draggable="true"] { cursor: grab; }
    .headline { font-weight: 700; font-size: 1.05rem; margin-bottom: 4px; }
    .text { white-space: pre-wrap; word-break: break-word; color: var(--muted); font-size: .95rem; }
    .meta { color: var(--muted); font-size: .75rem; margin-top: 4px; }
    .actions { display: flex; gap: 6px; }
    .icon-btn { background: transparent; color: var(--muted); border: 1px solid var(--border); padding: 6px 8px; border-radius: 8px; cursor: pointer; }
    .icon-btn:hover { color: var(--text); border-color: #334155; }
    .danger { color: #fecaca; border-color: #7f1d1d; }
    .danger:hover { color: white; border-color: #991b1b; background: rgba(239,68,68,.12); }

    /* Card menu */
    .card-menu {
      position: relative;
    }
    .card-menu-btn {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }
    .card-menu-btn:hover {
      color: var(--text);
      border-color: #334155;
      background: var(--border);
    }
    .card-menu-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 4px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      min-width: 120px;
      z-index: 100;
    }
    .card-menu-dropdown.show {
      display: block;
    }
    .card-menu-item {
      width: 100%;
      background: transparent;
      color: var(--text);
      border: none;
      padding: 10px 14px;
      text-align: left;
      cursor: pointer;
      border-radius: 0;
      box-shadow: none;
      font-weight: 400;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-menu-item:first-child {
      border-radius: 8px 8px 0 0;
    }
    .card-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }
    .card-menu-item:hover {
      background: var(--border);
    }
    .card-menu-item.danger {
      color: #fecaca;
    }
    .card-menu-item.danger:hover {
      background: rgba(239,68,68,.12);
      color: white;
    }

    /* Due date styling */
    .due-date {
      color: var(--muted);
      font-size: .75rem;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .due-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: .7rem;
      font-weight: 600;
      margin-left: 4px;
    }
    .due-today {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }
    .due-soon {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }
    .overdue {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }
    .card.overdue {
      border-color: #7f1d1d;
      background: linear-gradient(135deg, rgba(127, 29, 29, 0.1), var(--card));
    }
    .card.due-today {
      border-color: #78350f;
      background: linear-gradient(135deg, rgba(120, 53, 15, 0.1), var(--card));
    }

    footer { max-width: 1100px; margin: 0 auto 28px; padding: 0 16px; color: var(--muted); font-size: .9rem; }
    a { color: #93c5fd; }

    /* Undo toast */
    .undo-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .undo-toast button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .undo-toast button:hover {
      opacity: 0.9;
    }

    /* Add task dialog */
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .dialog {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .dialog h2 {
      margin: 0 0 20px 0;
      font-size: 1.3rem;
    }
    .dialog-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .dialog-form input,
    .dialog-form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
    }
    .dialog-form input[type="date"] {
      background: #1f2937;
      color: #e5e7eb;
      border: 2px solid var(--border);
      padding: 10px 40px 10px 12px;
      cursor: pointer;
      color-scheme: dark;
      position: relative;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23e5e7eb" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px;
    }
    .dialog-form input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 0;
      top: 0;
      width: 40px;
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: pointer;
      opacity: 0.01;
    }
    .dialog-form input[type="date"]:hover {
      border-color: var(--accent-2);
    }
    .dialog-form input[type="date"]:focus {
      border-color: var(--accent);
      outline: none;
    }
    .dialog-form textarea {
      resize: vertical;
      min-height: 80px;
    }
    .dialog-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .dialog-buttons button {
      flex: 1;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      header > div:first-child {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        width: 100%;
        gap: 8px;
      }
      header > div:first-child > div:first-child {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      header > div:first-child > div:first-child > div:first-child {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 0 1 auto;
        min-width: 0;
      }
      h1 {
        font-size: 1.2rem;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .auth-section {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
        flex: 0 0 auto;
      }
      .sync-status {
        justify-content: flex-start;
      }
      .user-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      .controls {
        flex-direction: column;
        width: 100%;
      }
      input[type="text"] {
        width: 100%;
      }
      button {
        width: 100%;
        padding: 12px 14px;
      }
      main {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .column {
        min-width: unset;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; width: 100%;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <h1 id="boardTitle">Enkel Kanban</h1>
          <span class="edit-icon" title="Klicka f√∂r att redigera namn">‚úèÔ∏è</span>
        </div>
        <div id="syncStatus" class="sync-status" style="display:none;">
          <span class="sync-indicator"></span>
          <span id="syncText">Sparad lokalt</span>
        </div>
        <div class="mobile-menu">
          <button type="button" class="menu-btn" id="mobileMenuBtn" title="Mer">‚ãÆ</button>
          <div class="menu-dropdown" id="menuDropdown">
            <button type="button" class="menu-item" id="exportBtnMobile">üì• Exportera</button>
            <button type="button" class="menu-item" id="importBtnMobile">üì§ Importera</button>
          </div>
        </div>
      </div>
      <div class="auth-section">
        <div id="userInfo" style="display:none;" class="user-info">
          <img id="userAvatar" class="user-avatar" alt="User" />
          <span id="userName"></span>
          <button id="signOutBtn" class="ghost" title="Logga ut">Logga ut</button>
        </div>
        <button id="signInBtn" class="secondary" style="display:none;" title="Logga in med Google">
          <span>üîê Logga in</span>
        </button>
      </div>
    </div>
    <div class="controls">
      <button id="addTaskBtn" type="button" title="L√§gg till ny uppgift">‚ûï L√§gg till</button>
    </div>
  </header>

  <main>
    <section class="column" data-col="todo" aria-label="Att g√∂ra">
      <div class="col-header">
        <div class="col-title">Att g√∂ra</div>
        <div>
          <button class="icon-btn" data-clear="todo" title="T√∂m kolumn">T√∂m</button>
        </div>
      </div>
      <div class="dropzone" data-col="todo" aria-label="Sl√§pp uppgifter h√§r" aria-dropeffect="move"></div>
    </section>

    <section class="column" data-col="doing" aria-label="P√•g√•r">
      <div class="col-header">
        <div class="col-title">P√•g√•r</div>
        <div>
          <button class="icon-btn" data-clear="doing" title="T√∂m kolumn">T√∂m</button>
        </div>
      </div>
      <div class="dropzone" data-col="doing" aria-label="Sl√§pp uppgifter h√§r" aria-dropeffect="move"></div>
    </section>

    <section class="column" data-col="done" aria-label="Klart">
      <div class="col-header">
        <div class="col-title">Klart</div>
        <div>
          <button class="icon-btn" data-clear="done" title="T√∂m kolumn">T√∂m</button>
        </div>
      </div>
      <div class="dropzone" data-col="done" aria-label="Sl√§pp uppgifter h√§r" aria-dropeffect="move"></div>
    </section>
  </main>

  <footer>
    Tips: Dra & sl√§pp kort mellan kolumner. Klicka p√• ‚ãÆ p√• ett kort f√∂r att redigera eller ta bort. Allt sparas automatiskt lokalt och synkas till molnet n√§r du √§r inloggad.
  </footer>


  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCjQLnpI8DOhbZaheiWKDDSCZcHOZIxz4U",
      authDomain: "personal-kanban-ae9b7.firebaseapp.com",
      projectId: "personal-kanban-ae9b7",
      storageBucket: "personal-kanban-ae9b7.firebasestorage.app",
      messagingSenderId: "916501713123",
      appId: "1:916501713123:web:bdf498b9d459ccb2f9f5d6"
    };

    // Initialize Firebase
    let app, auth, db, currentUser = null, unsubscribe = null;
    let syncEnabled = false;

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      syncEnabled = true;
    } catch (e) {
      console.warn('Firebase not configured properly. Using local storage only.', e);
    }

    // Export Firebase functions to global scope
    window.firebaseAuth = {
      signIn: async () => {
        if (!syncEnabled) return alert('Firebase √§r inte konfigurerad. Kontakta administrat√∂ren.');
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error('Sign in error:', error);
          alert('Kunde inte logga in: ' + error.message);
        }
      },
      signOut: async () => {
        if (!syncEnabled) return;
        try {
          if (unsubscribe) unsubscribe();
          await signOut(auth);
        } catch (error) {
          console.error('Sign out error:', error);
        }
      },
      onAuthChange: (callback) => {
        if (!syncEnabled) return;
        onAuthStateChanged(auth, callback);
      },
      syncToFirestore: async (userId, boardTitle, boardData) => {
        if (!syncEnabled || !userId) return;
        try {
          window.updateSyncStatus('syncing', 'Synkar...');
          await setDoc(doc(db, 'kanban_boards', userId), {
            title: boardTitle,
            board: boardData,
            lastModified: Date.now()
          });
          window.updateSyncStatus('synced', 'Synkad');
          // Show "Synced" status for at least 1 second
          setTimeout(() => {
            if (document.querySelector('.sync-indicator.synced')) {
              // Still synced, keep showing it
            }
          }, 1000);
        } catch (error) {
          console.error('Sync error:', error);
          window.updateSyncStatus('error', 'Synkfel');
        }
      },
      loadFromFirestore: async (userId) => {
        if (!syncEnabled || !userId) return null;
        try {
          const docRef = doc(db, 'kanban_boards', userId);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            return docSnap.data();
          }
          return null;
        } catch (error) {
          console.error('Load error:', error);
          return null;
        }
      },
      listenToChanges: (userId, callback) => {
        if (!syncEnabled || !userId) return null;
        const docRef = doc(db, 'kanban_boards', userId);
        return onSnapshot(docRef, (doc) => {
          if (doc.exists()) {
            callback(doc.data());
          }
        });
      }
    };

    // Make updateSyncStatus globally accessible
    window.updateSyncStatus = function(state, text) {
      const indicator = document.querySelector('.sync-indicator');
      const syncText = document.getElementById('syncText');
      if (indicator && syncText) {
        indicator.className = 'sync-indicator ' + state;
        syncText.textContent = text;
      }
    };

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFirebaseUI);
    } else {
      initFirebaseUI();
    }

    function initFirebaseUI() {
      console.log('Initializing Firebase UI...');
      
      // Show/hide UI elements based on Firebase availability
      if (syncEnabled) {
        const signInBtn = document.getElementById('signInBtn');
        const syncStatus = document.getElementById('syncStatus');
        
        console.log('Firebase enabled, signInBtn:', signInBtn, 'syncStatus:', syncStatus);
        
        if (signInBtn) {
          signInBtn.style.display = 'block';
          signInBtn.addEventListener('click', () => {
            console.log('Sign in button clicked in module!');
            window.firebaseAuth.signIn();
          });
        }
        
        if (syncStatus) {
          syncStatus.style.display = 'flex';
        }

        // Set up auth state listener
        setupAuthStateListener();
      } else {
        console.log('Firebase not enabled');
      }
    }

    function setupAuthStateListener() {
      console.log('Setting up auth state listener...');
      
      onAuthStateChanged(auth, async (user) => {
        console.log('Auth state changed, user:', user);
        
        if (user) {
          // User is signed in
          console.log('User signed in:', user.displayName || user.email);
          
          // Update UI
          const signInBtn = document.getElementById('signInBtn');
          const userInfo = document.getElementById('userInfo');
          const userName = document.getElementById('userName');
          const userAvatar = document.getElementById('userAvatar');
          
          if (signInBtn) signInBtn.style.display = 'none';
          if (userInfo) userInfo.style.display = 'flex';
          if (userName) userName.textContent = user.displayName || user.email;
          if (userAvatar && user.photoURL) userAvatar.src = user.photoURL;

          // Update sync status to show syncing
          window.updateSyncStatus('syncing', 'Synkar...');

          // Notify main script
          window.dispatchEvent(new CustomEvent('firebaseAuthChanged', { 
            detail: { user, signedIn: true } 
          }));

        } else {
          // User is signed out
          console.log('User signed out');
          
          // Update UI
          const signInBtn = document.getElementById('signInBtn');
          const userInfo = document.getElementById('userInfo');
          
          if (signInBtn) signInBtn.style.display = 'block';
          if (userInfo) userInfo.style.display = 'none';
          
          // Update sync status
          window.updateSyncStatus('', 'Sparad lokalt');

          // Notify main script
          window.dispatchEvent(new CustomEvent('firebaseAuthChanged', { 
            detail: { user: null, signedIn: false } 
          }));
        }
      });
    }
  </script>

  <script>
    const STORAGE_KEY = 'simple-kanban-v1';

    /** @typedef {{ id:string, headline:string, text:string, created:number }} Task */
    /** @typedef {{ todo: Task[], doing: Task[], done: Task[] }} Board */

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    let currentUserId = null;
    let isApplyingRemoteUpdate = false;  // True when receiving data from Firestore
    let syncUnsubscribe = null;
    let syncTimeout = null;

    /** @returns {Board} */
    function load(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { todo: [], doing: [], done: [] };
        const data = JSON.parse(raw);
        return { todo: data.todo||[], doing: data.doing||[], done: data.done||[] };
      } catch(e){
        console.warn('Kunde inte l√§sa lagring', e); return { todo: [], doing: [], done: [] };
      }
    }
    /** @param {Board} data */
    function save(data){ 
      // Don't save if we're currently applying a remote update
      if (isApplyingRemoteUpdate) {
        console.log('Skipping save - applying remote update');
        return;
      }
      
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      localStorage.setItem('lastModified', Date.now().toString());
      
      // Debounce sync to Firestore (wait 500ms after last change)
      if (currentUserId && window.firebaseAuth) {
        if (syncTimeout) clearTimeout(syncTimeout);
        syncTimeout = setTimeout(async () => {
          console.log('Syncing local changes to Firestore');
          await window.firebaseAuth.syncToFirestore(currentUserId, loadBoardTitle(), data);
        }, 500);
      }
    }

    function loadBoardTitle(){
      return localStorage.getItem('kanban-board-title') || 'Enkel Kanban';
    }
    function saveBoardTitle(title){ 
      // Don't save if we're currently applying a remote update
      if (isApplyingRemoteUpdate) {
        console.log('Skipping title save - applying remote update');
        return;
      }
      
      localStorage.setItem('kanban-board-title', title);
      
      // Debounce sync title to Firestore
      if (currentUserId && window.firebaseAuth) {
        if (syncTimeout) clearTimeout(syncTimeout);
        syncTimeout = setTimeout(async () => {
          console.log('Syncing title to Firestore');
          await window.firebaseAuth.syncToFirestore(currentUserId, title, board);
        }, 500);
      }
    }

    /** @type {Board} */
    let board = load();

    function uid(){ return Math.random().toString(36).slice(2,9); }

    // Notification functions
    async function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        await Notification.requestPermission();
      }
    }

    function checkOverdueTasks() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let overdueCount = 0;
      let dueTodayCount = 0;
      
      ['todo', 'doing'].forEach(col => {
        board[col].forEach(task => {
          if (task.dueDate) {
            const dueDate = new Date(task.dueDate);
            dueDate.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) overdueCount++;
            else if (diffDays === 0) dueTodayCount++;
          }
        });
      });
      
      if ('Notification' in window && Notification.permission === 'granted') {
        if (overdueCount > 0) {
          new Notification('F√∂rsenade uppgifter', {
            body: `Du har ${overdueCount} f√∂rsenad${overdueCount > 1 ? 'e' : ''} uppgift${overdueCount > 1 ? 'er' : ''}!`,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">‚ö†Ô∏è</text></svg>',
            tag: 'overdue-tasks'
          });
        } else if (dueTodayCount > 0) {
          new Notification('Uppgifter att g√∂ra idag', {
            body: `Du har ${dueTodayCount} uppgift${dueTodayCount > 1 ? 'er' : ''} som ska slutf√∂ras idag.`,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üìÖ</text></svg>',
            tag: 'due-today-tasks'
          });
        }
      }
    }

    // Check for overdue tasks on load
    setTimeout(() => {
      requestNotificationPermission().then(() => {
        checkOverdueTasks();
      });
    }, 2000);

    // Check every hour for overdue tasks
    setInterval(checkOverdueTasks, 60 * 60 * 1000);

    function render(){
      ['todo','doing','done'].forEach(col => {
        const zone = `.dropzone[data-col="${col}"]`;
        const container = document.querySelector(zone);
        container.innerHTML = '';
        board[col].forEach(task => container.appendChild(renderCard(task, col)));
      });
    }

    function renderCard(task, column){
      const el = document.createElement('article');
      el.className = 'card';
      el.setAttribute('draggable', 'true');
      el.dataset.id = task.id;

      el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ id: task.id }));
      });

      const headline = document.createElement('div');
      headline.className = 'headline';
      headline.textContent = task.headline || task.text;

      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = task.text || '';
      if (!task.headline) text.style.display = 'none';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = 'üïê Skapad: ' + new Date(task.created).toLocaleDateString('sv-SE');

      const left = document.createElement('div');
      left.appendChild(headline); 
      left.appendChild(text); 
      
      // Add due date display
      if (task.dueDate) {
        const dueDate = document.createElement('div');
        dueDate.className = 'due-date';
        const dueDateObj = new Date(task.dueDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDateTime = new Date(dueDateObj);
        dueDateTime.setHours(0, 0, 0, 0);
        const diffDays = Math.ceil((dueDateTime - today) / (1000 * 60 * 60 * 24));
        
        let badgeHtml = '';
        if (column !== 'done') {
          if (diffDays < 0) {
            badgeHtml = '<span class="due-badge overdue">F√∂rsenad</span>';
            el.classList.add('overdue');
          } else if (diffDays === 0) {
            badgeHtml = '<span class="due-badge due-today">Idag</span>';
            el.classList.add('due-today');
          } else if (diffDays <= 3) {
            badgeHtml = '<span class="due-badge due-soon">Snart</span>';
          }
        }
        
        dueDate.innerHTML = `üìÖ Slutdatum: ${dueDateObj.toLocaleDateString('sv-SE')}${badgeHtml}`;
        left.appendChild(dueDate);
      }
      
      left.appendChild(meta);

      const menuContainer = document.createElement('div');
      menuContainer.className = 'card-menu';

      const menuBtn = document.createElement('button');
      menuBtn.className = 'card-menu-btn';
      menuBtn.innerText = '‚ãÆ';
      menuBtn.title = '√Ötg√§rder';
      
      const menuDropdown = document.createElement('div');
      menuDropdown.className = 'card-menu-dropdown';

      const editBtn = document.createElement('button');
      editBtn.className = 'card-menu-item';
      editBtn.innerHTML = '‚úèÔ∏è Redigera';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.remove('show');
        showEditTaskDialog(task);
      });

      menuDropdown.appendChild(editBtn);

      // Add "Move to" options based on current column
      if (column === 'todo') {
        const moveToDoingBtn = document.createElement('button');
        moveToDoingBtn.className = 'card-menu-item';
        moveToDoingBtn.innerHTML = '‚ñ∂Ô∏è Flytta till P√•g√•r';
        moveToDoingBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          menuDropdown.classList.remove('show');
          moveTask(task.id, 'doing');
        });
        menuDropdown.appendChild(moveToDoingBtn);
      } else if (column === 'doing') {
        const moveToDoneBtn = document.createElement('button');
        moveToDoneBtn.className = 'card-menu-item';
        moveToDoneBtn.innerHTML = '‚úÖ Flytta till Klart';
        moveToDoneBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          menuDropdown.classList.remove('show');
          moveTask(task.id, 'done');
        });
        menuDropdown.appendChild(moveToDoneBtn);
        
        const moveToTodoBtn = document.createElement('button');
        moveToTodoBtn.className = 'card-menu-item';
        moveToTodoBtn.innerHTML = '‚óÄÔ∏è Flytta till Att g√∂ra';
        moveToTodoBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          menuDropdown.classList.remove('show');
          moveTask(task.id, 'todo');
        });
        menuDropdown.appendChild(moveToTodoBtn);
      } else if (column === 'done') {
        const moveToDoingBtn = document.createElement('button');
        moveToDoingBtn.className = 'card-menu-item';
        moveToDoingBtn.innerHTML = '‚óÄÔ∏è Flytta till P√•g√•r';
        moveToDoingBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          menuDropdown.classList.remove('show');
          moveTask(task.id, 'doing');
        });
        menuDropdown.appendChild(moveToDoingBtn);
      }

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'card-menu-item danger';
      deleteBtn.innerHTML = 'üóëÔ∏è Ta bort';
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.remove('show');
        removeTask(task.id);
      });

      menuDropdown.appendChild(deleteBtn);
      menuContainer.appendChild(menuBtn);
      menuContainer.appendChild(menuDropdown);

      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.card-menu-dropdown').forEach(d => {
          if (d !== menuDropdown) d.classList.remove('show');
        });
        menuDropdown.classList.toggle('show');
      });

      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.appendChild(menuContainer);

      el.appendChild(left); el.appendChild(actions);

      return el;
    }

    function showEditTaskDialog(task) {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'dialog-overlay';
      
      // Create dialog
      const dialog = document.createElement('div');
      dialog.className = 'dialog';
      dialog.innerHTML = `
        <h2>Redigera uppgift</h2>
        <form class="dialog-form" id="dialogForm">
          <input type="text" id="dialogHeadline" placeholder="Rubrik (obligatorisk)" required autofocus />
          <textarea id="dialogText" placeholder="Beskrivning (valfri)"></textarea>
          <label for="dialogDueDate" style="color: var(--muted); font-size: 0.9rem; margin-top: 4px;">üìÖ Slutdatum (valfritt):</label>
          <input type="date" id="dialogDueDate" />
          <div class="dialog-buttons">
            <button type="button" class="ghost" id="dialogCancel">Avbryt</button>
            <button type="submit">Spara</button>
          </div>
        </form>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      // Populate with existing values
      $('#dialogHeadline').value = task.headline || task.text || '';
      $('#dialogText').value = task.text || '';
      $('#dialogDueDate').value = task.dueDate || '';
      
      // Focus headline input
      setTimeout(() => $('#dialogHeadline').focus(), 100);
      
      // Cancel button
      $('#dialogCancel').addEventListener('click', () => {
        overlay.remove();
      });
      
      // Click outside to close
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
      
      // Submit form
      $('#dialogForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const headline = $('#dialogHeadline').value.trim();
        const text = $('#dialogText').value.trim();
        const dueDate = $('#dialogDueDate').value;
        if (!headline) return;
        
        task.headline = headline;
        task.text = text;
        task.dueDate = dueDate;
        save(board);
        render();
        overlay.remove();
      });
      
      // Escape key to close
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          overlay.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }

    function addTask(headline, text='', column='todo', dueDate=''){
      const task = { id: uid(), headline, text, dueDate, created: Date.now() };
      board[column].push(task); save(board); render();
    }

    let undoTimeout = null;
    let deletedTask = null;
    let deletedColumn = null;

    function removeTask(id){
      // Save for undo
      ['todo','doing','done'].forEach(col => {
        const i = board[col].findIndex(t => t.id === id);
        if(i>-1) {
          deletedTask = board[col][i];
          deletedColumn = col;
          board[col].splice(i,1);
        }
      });
      save(board); render();
      showUndoToast();
    }

    function showUndoToast() {
      // Remove existing toast if any
      const existing = document.querySelector('.undo-toast');
      if (existing) existing.remove();
      if (undoTimeout) clearTimeout(undoTimeout);

      // Create toast
      const toast = document.createElement('div');
      toast.className = 'undo-toast';
      toast.innerHTML = `
        <span>Uppgift borttagen</span>
        <button id="undoBtn">√Öngra</button>
      `;
      document.body.appendChild(toast);

      // Undo button
      document.getElementById('undoBtn').addEventListener('click', () => {
        if (deletedTask && deletedColumn) {
          board[deletedColumn].push(deletedTask);
          save(board);
          render();
          deletedTask = null;
          deletedColumn = null;
        }
        toast.remove();
        if (undoTimeout) clearTimeout(undoTimeout);
      });

      // Auto-remove after 5 seconds
      undoTimeout = setTimeout(() => {
        toast.remove();
        deletedTask = null;
        deletedColumn = null;
      }, 5000);
    }

    function moveTask(id, toCol){
      if(!['todo','doing','done'].includes(toCol)) return;
      let moving = null, from = null;
      for(const col of ['todo','doing','done']){
        const i = board[col].findIndex(t => t.id===id);
        if(i>-1){ moving = board[col].splice(i,1)[0]; from = col; break; }
      }
      if(moving){ board[toCol].push(moving); save(board); render(); }
    }

    // DnD
    $$('.dropzone').forEach(zone => {
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('dragover');
        try { const { id } = JSON.parse(e.dataTransfer.getData('text/plain')); moveTask(id, zone.dataset.col); }
        catch{}
      });
    });

    // Add task button - show dialog
    $('#addTaskBtn').addEventListener('click', () => {
      showAddTaskDialog();
    });

    function showAddTaskDialog() {
      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'dialog-overlay';
      
      // Create dialog
      const dialog = document.createElement('div');
      dialog.className = 'dialog';
      dialog.innerHTML = `
        <h2>L√§gg till ny uppgift</h2>
        <form class="dialog-form" id="dialogForm">
          <input type="text" id="dialogHeadline" placeholder="Rubrik (obligatorisk)" required autofocus />
          <textarea id="dialogText" placeholder="Beskrivning (valfri)"></textarea>
          <label for="dialogDueDate" style="color: var(--muted); font-size: 0.9rem; margin-top: 4px;">üìÖ Slutdatum (valfritt):</label>
          <input type="date" id="dialogDueDate" />
          <div class="dialog-buttons">
            <button type="button" class="ghost" id="dialogCancel">Avbryt</button>
            <button type="submit">L√§gg till</button>
          </div>
        </form>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      // Focus headline input
      setTimeout(() => $('#dialogHeadline').focus(), 100);
      
      // Cancel button
      $('#dialogCancel').addEventListener('click', () => {
        overlay.remove();
      });
      
      // Click outside to close
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.remove();
        }
      });
      
      // Submit form
      $('#dialogForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const headline = $('#dialogHeadline').value.trim();
        const text = $('#dialogText').value.trim();
        const dueDate = $('#dialogDueDate').value;
        if (!headline) return;
        
        addTask(headline, text, 'todo', dueDate);
        overlay.remove();
      });
      
      // Escape key to close
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          overlay.remove();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }

    // Mobile menu toggle
    const mobileMenuBtn = $('#mobileMenuBtn');
    const menuDropdown = $('#menuDropdown');
    if (mobileMenuBtn && menuDropdown) {
      mobileMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle('show');
      });

      // Close menu when clicking outside
      document.addEventListener('click', () => {
        menuDropdown.classList.remove('show');
      });

      // Prevent menu from closing when clicking inside
      menuDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // Close card menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.card-menu')) {
        document.querySelectorAll('.card-menu-dropdown').forEach(menu => {
          menu.classList.remove('show');
        });
      }
    });

    // Mobile export button
    $('#exportBtnMobile')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(board, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'kanban.json'; a.click(); URL.revokeObjectURL(url);
      menuDropdown?.classList.remove('show');
    });

    // Mobile import button
    $('#importBtnMobile')?.addEventListener('click', async () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files?.[0]; if(!file) return;
        try { const text = await file.text(); const data = JSON.parse(text);
          if(['todo','doing','done'].every(k => Array.isArray(data[k]))){ board = { todo: data.todo, doing: data.doing, done: data.done }; save(board); render(); }
          else alert('Ogiltigt JSON-format');
        } catch { alert('Kunde inte l√§sa filen'); }
      };
      input.click();
      menuDropdown?.classList.remove('show');
    });

    // Clear buttons
    $$('button[data-clear]').forEach(btn => btn.addEventListener('click', () => {
      const col = btn.getAttribute('data-clear');
      if (confirm(`T√∂m kolumnen "${col}"?`)) { board[col] = []; save(board); render(); }
    }));

    // Sign out button
    $('#signOutBtn')?.addEventListener('click', () => {
      if (confirm('Vill du logga ut? Dina uppgifter kommer fortfarande att finnas kvar i molnet.')) {
        if (window.firebaseAuth) {
          window.firebaseAuth.signOut();
        }
      }
    });

    // Editable board title
    const titleEl = $('#boardTitle');
    titleEl.textContent = loadBoardTitle();
    titleEl.addEventListener('click', () => {
      const current = titleEl.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = current;
      input.style.fontSize = '1.4rem';
      input.style.fontWeight = 'inherit';
      input.style.background = 'transparent';
      input.style.color = 'inherit';
      input.style.border = '1px solid var(--border)';
      input.style.borderRadius = '8px';
      input.style.padding = '6px 10px';
      input.style.width = 'max-content';
      input.style.minWidth = '200px';
      titleEl.replaceWith(input);
      input.focus();
      input.select();
      const finish = () => {
        const val = input.value.trim() || 'Enkel Kanban';
        saveBoardTitle(val);
        titleEl.textContent = val;
        document.title = val;
        input.replaceWith(titleEl);
      };
      input.addEventListener('blur', finish);
      input.addEventListener('keydown', e => { if(e.key==='Enter') finish(); if(e.key==='Escape') { titleEl.textContent = current; input.replaceWith(titleEl); } });
    });

    // Export/Import JSON
    $('#exportBtnMobile')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(board, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'kanban.json'; a.click(); URL.revokeObjectURL(url);
      // Close menu
      $('#menuDropdown').classList.remove('show');
    });
    $('#importBtnMobile')?.addEventListener('click', async () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files?.[0]; if(!file) return;
        try { const text = await file.text(); const data = JSON.parse(text);
          if(['todo','doing','done'].every(k => Array.isArray(data[k]))){ board = { todo: data.todo, doing: data.doing, done: data.done }; save(board); render(); }
          else alert('Ogiltigt JSON-format');
        } catch { alert('Kunde inte l√§sa filen'); }
      };
      input.click();
      // Close menu
      $('#menuDropdown').classList.remove('show');
    });

    // Render initial board (no example tasks - could overwrite cloud data)
    render();

    // Set page title to match board title
    document.title = loadBoardTitle();

    // Firebase Authentication handlers - listen for auth changes from module
    window.addEventListener('firebaseAuthChanged', async (event) => {
      console.log('Auth changed event received:', event.detail);
      const { user, signedIn } = event.detail;

      if (signedIn && user) {
        // User signed in
        currentUserId = user.uid;
        window.updateSyncStatus('syncing', 'Laddar...');

        // Load data from Firestore
        if (window.firebaseAuth) {
          const cloudData = await window.firebaseAuth.loadFromFirestore(user.uid);
          console.log('Cloud data loaded:', cloudData);
          
          if (cloudData) {
            // Cloud data exists - merge with local data
            const localModified = parseInt(localStorage.getItem('lastModified') || '0');
            const hasLocalData = board.todo.length > 0 || board.doing.length > 0 || board.done.length > 0;
            
            if (!hasLocalData && !localModified) {
              // No local data at all - use cloud data
              console.log('No local data, using cloud data');
              isApplyingRemoteUpdate = true;
              board = cloudData.board;
              const newTitle = cloudData.title;
              $('#boardTitle').textContent = newTitle;
              document.title = newTitle;
              saveBoardTitle(newTitle);
              save(board);
              render();
              isApplyingRemoteUpdate = false;
              window.updateSyncStatus('synced', 'Synkad');
            } else if (cloudData.lastModified > localModified && hasLocalData) {
              // Cloud is newer but we have local data - merge them
              console.log('Cloud data is newer, merging with local data');
              
              // Create a map of existing tasks by ID from cloud
              const cloudTaskIds = new Set();
              ['todo', 'doing', 'done'].forEach(col => {
                cloudData.board[col].forEach(task => cloudTaskIds.add(task.id));
              });
              
              // Merge: Keep all cloud tasks + add local tasks that don't exist in cloud
              const merged = { todo: [], doing: [], done: [] };
              
              // First, add all cloud tasks
              ['todo', 'doing', 'done'].forEach(col => {
                merged[col] = [...cloudData.board[col]];
              });
              
              // Then, add local tasks that are NOT in cloud (new offline tasks)
              ['todo', 'doing', 'done'].forEach(col => {
                board[col].forEach(task => {
                  if (!cloudTaskIds.has(task.id)) {
                    // This is a new task created offline, add it
                    merged[col].push(task);
                    console.log(`Adding new offline task: ${task.headline}`);
                  }
                });
              });
              
              isApplyingRemoteUpdate = true;
              board = merged;
              const newTitle = cloudData.title;
              $('#boardTitle').textContent = newTitle;
              document.title = newTitle;
              saveBoardTitle(newTitle);
              save(board);
              render();
              
              // Upload merged data to cloud
              isApplyingRemoteUpdate = false;
              await window.firebaseAuth.syncToFirestore(user.uid, loadBoardTitle(), board);
              console.log('Merged data (with offline tasks) uploaded to cloud');
              window.updateSyncStatus('synced', 'Synkad');
            } else if (cloudData.lastModified > localModified && !hasLocalData) {
              // Cloud is newer and no local data - use cloud data
              console.log('Cloud data is newer, using cloud data');
              isApplyingRemoteUpdate = true;
              board = cloudData.board;
              const newTitle = cloudData.title;
              $('#boardTitle').textContent = newTitle;
              document.title = newTitle;
              saveBoardTitle(newTitle);
              save(board);
              render();
              isApplyingRemoteUpdate = false;
              window.updateSyncStatus('synced', 'Synkad');
            } else {
              // Local has changes - merge intelligently
              console.log('Merging local and cloud data');
              
              // Create a map of existing tasks by ID from cloud
              const cloudTaskIds = new Set();
              ['todo', 'doing', 'done'].forEach(col => {
                cloudData.board[col].forEach(task => cloudTaskIds.add(task.id));
              });
              
              // Merge: Keep all cloud tasks + add local tasks that don't exist in cloud
              const merged = { todo: [], doing: [], done: [] };
              
              // First, add all cloud tasks
              ['todo', 'doing', 'done'].forEach(col => {
                merged[col] = [...cloudData.board[col]];
              });
              
              // Then, add local tasks that are NOT in cloud (new tasks)
              ['todo', 'doing', 'done'].forEach(col => {
                board[col].forEach(task => {
                  if (!cloudTaskIds.has(task.id)) {
                    // This is a new task created locally, add it
                    merged[col].push(task);
                    console.log(`Adding new local task: ${task.headline}`);
                  }
                });
              });
              
              isApplyingRemoteUpdate = true;
              board = merged;
              // Keep local title if modified, otherwise use cloud title
              const localTitle = loadBoardTitle();
              if (localTitle !== 'Enkel Kanban' && localTitle !== cloudData.title) {
                $('#boardTitle').textContent = localTitle;
                document.title = localTitle;
              } else {
                $('#boardTitle').textContent = cloudData.title;
                document.title = cloudData.title;
                saveBoardTitle(cloudData.title);
              }
              save(board);
              render();
              
              // Upload merged data to cloud
              isApplyingRemoteUpdate = false;
              await window.firebaseAuth.syncToFirestore(user.uid, loadBoardTitle(), board);
              console.log('Merged data uploaded to cloud');
              window.updateSyncStatus('synced', 'Synkad');
            }
          } else {
            // No cloud data exists yet
            console.log('No cloud data found');
            // Only upload local data if it's not empty
            const hasLocalData = board.todo.length > 0 || board.doing.length > 0 || board.done.length > 0;
            if (hasLocalData) {
              console.log('No cloud data, uploading local data');
              await window.firebaseAuth.syncToFirestore(user.uid, loadBoardTitle(), board);
              window.updateSyncStatus('synced', 'Synkad');
            } else {
              console.log('No cloud data and no local data - starting fresh');
              window.updateSyncStatus('synced', 'Synkad');
            }
            // Always render after sync check
            render();
          }

          // Listen for real-time updates
          if (syncUnsubscribe) syncUnsubscribe();
          syncUnsubscribe = window.firebaseAuth.listenToChanges(user.uid, (data) => {
            console.log('Realtime update received:', data);
            console.log('isApplyingRemoteUpdate:', isApplyingRemoteUpdate, 'lastModified:', localStorage.getItem('lastModified'), 'cloud:', data.lastModified);
            
            if (!isApplyingRemoteUpdate) {
              const localModified = parseInt(localStorage.getItem('lastModified') || '0');
              // Always render on first snapshot, or if cloud is newer
              if (!localModified || data.lastModified > localModified) {
                console.log('Applying realtime update');
                isApplyingRemoteUpdate = true;
                board = data.board;
                const newTitle = data.title;
                $('#boardTitle').textContent = newTitle;
                document.title = newTitle;
                localStorage.setItem('kanban-board-title', newTitle);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data.board));
                localStorage.setItem('lastModified', data.lastModified.toString());
                render();
                // Quick delay to prevent save() triggering during render, then mark synced
                setTimeout(() => { 
                  isApplyingRemoteUpdate = false; 
                  window.updateSyncStatus('synced', 'Synkad'); 
                }, 100);
              } else {
                console.log('Skipping realtime update - local is newer or same');
                window.updateSyncStatus('synced', 'Synkad');
              }
            } else {
              console.log('Skipping realtime update - already applying remote update');
            }
          });
        }
      } else {
        // User signed out
        currentUserId = null;
        if (syncUnsubscribe) syncUnsubscribe();
      }
    });
  </script>
</body>
</html>
