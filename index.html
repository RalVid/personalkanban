<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enkel Kanban</title>
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --card: #111827;      /* gray-900 */
      --muted: #94a3b8;     /* slate-400 */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #22c55e;    /* green-500 */
      --accent-2: #3b82f6;  /* blue-500 */
      --danger: #ef4444;    /* red-500 */
      --border: #1f2937;    /* gray-800 */
      --shadow: 0 10px 20px rgba(0,0,0,.25);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 20% -10%, #1f2937 0%, var(--bg) 40%), var(--bg);
      color: var(--text);
    }
    header {
      max-width: 1100px; margin: 24px auto 8px; padding: 0 16px;
      display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;
    }
    h1 { 
      font-size: 1.4rem; margin: 0; letter-spacing: .3px; cursor: pointer;
    }
    h1:hover { opacity: 0.8; }
    h1:hover + .edit-icon { opacity: 1; }
    .edit-icon {
      font-size: 1rem;
      opacity: 0.5;
      transition: opacity 0.2s;
      cursor: pointer;
    }
    .controls {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
    }
    input[type="text"]{
      background: var(--card); border: 1px solid var(--border); color: var(--text);
      padding: 10px 12px; border-radius: 10px; width: min(360px, 60vw);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.02);
    }
    button {
      border: 0; background: var(--accent); color: #051b0d; font-weight: 700;
      padding: 10px 14px; border-radius: 10px; cursor: pointer; box-shadow: var(--shadow);
      white-space: nowrap;
    }
    button.secondary { background: var(--accent-2); color: #0b1220; }
    button.ghost { background: transparent; color: var(--muted); box-shadow: none; border: 1px solid var(--border); }
    /* Hide export/import buttons - use menu instead */
    #exportBtn, #importBtn { display: none; }
    /* Hide menu - not needed with cloud sync */
    .mobile-menu { display: none; }
    .sync-status { display: flex; align-items: center; gap: 8px; font-size: .85rem; color: var(--muted); }
    .sync-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); }
    .sync-indicator.synced { background: var(--accent); }
    .sync-indicator.syncing { background: var(--accent-2); animation: pulse 1.5s infinite; }
    .sync-indicator.error { background: var(--danger); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .auth-section { display: flex; align-items: center; gap: 8px; }
    .user-info { display: flex; align-items: center; gap: 8px; font-size: .9rem; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; }
    
    /* Mobile menu */
    .mobile-menu {
      position: relative;
    }
    .menu-btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 8px;
    }
    .menu-btn:hover {
      background: var(--border);
    }
    .menu-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 4px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      min-width: 200px;
      z-index: 1000;
    }
    .menu-dropdown.show {
      display: block;
    }
    .menu-item {
      width: 100%;
      background: transparent;
      color: var(--text);
      border: none;
      padding: 12px 16px;
      text-align: left;
      cursor: pointer;
      border-radius: 0;
      box-shadow: none;
    }
    .menu-item:first-child {
      border-radius: 12px 12px 0 0;
    }
    .menu-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    .menu-item:hover {
      background: var(--border);
    }

    main {
      max-width: 1100px; margin: 16px auto 40px; padding: 0 16px;
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
    }
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }

    .column {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border: 1px solid var(--border); border-radius: var(--radius); min-height: 260px;
      display: flex; flex-direction: column; box-shadow: var(--shadow);
    }
    .col-header { display:flex; justify-content: space-between; align-items: center; padding: 14px 14px 8px; }
    .col-title { font-weight: 700; letter-spacing: .3px; }

    .dropzone {
      padding: 8px 10px 14px; flex: 1; border-radius: 0 0 var(--radius) var(--radius);
      outline: 2px dashed transparent; outline-offset: -6px;
      transition: outline-color .15s ease, background-color .15s ease;
    }
    .dropzone.dragover { outline-color: #3b82f6aa; background: rgba(59,130,246,0.07); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      padding: 10px 12px; margin: 8px 4px; box-shadow: var(--shadow);
      display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: start;
    }
    .card[draggable="true"] { cursor: grab; }
    .headline { font-weight: 700; font-size: 1.05rem; margin-bottom: 4px; }
    .text { white-space: pre-wrap; word-break: break-word; color: var(--muted); font-size: .95rem; }
    .meta { color: var(--muted); font-size: .75rem; margin-top: 4px; }
    .actions { display: flex; gap: 6px; }
    .icon-btn { background: transparent; color: var(--muted); border: 1px solid var(--border); padding: 6px 8px; border-radius: 8px; cursor: pointer; }
    .icon-btn:hover { color: var(--text); border-color: #334155; }
    .danger { color: #fecaca; border-color: #7f1d1d; }
    .danger:hover { color: white; border-color: #991b1b; background: rgba(239,68,68,.12); }

    footer { max-width: 1100px; margin: 0 auto 28px; padding: 0 16px; color: var(--muted); font-size: .9rem; }
    a { color: #93c5fd; }

    /* Undo toast */
    .undo-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .undo-toast button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .undo-toast button:hover {
      opacity: 0.9;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      h1 {
        font-size: 1.2rem;
        text-align: center;
      }
      .auth-section {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .controls {
        flex-direction: column;
        width: 100%;
      }
      input[type="text"] {
        width: 100%;
      }
      button {
        width: 100%;
        padding: 12px 14px;
      }
      main {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .column {
        min-width: unset;
      }
      .sync-status {
        justify-content: center;
      }
      .user-info {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; gap: 12px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <h1 id="boardTitle">Enkel Kanban</h1>
        <span class="edit-icon" title="Klicka f√∂r att redigera namn">‚úèÔ∏è</span>
      </div>
      <div class="mobile-menu">
        <button type="button" class="menu-btn" id="mobileMenuBtn" title="Mer">‚ãÆ</button>
        <div class="menu-dropdown" id="menuDropdown">
          <button type="button" class="menu-item" id="exportBtnMobile">üì• Exportera</button>
          <button type="button" class="menu-item" id="importBtnMobile">üì§ Importera</button>
        </div>
      </div>
    </div>
    <div class="auth-section">
      <div id="syncStatus" class="sync-status" style="display:none;">
        <span class="sync-indicator"></span>
        <span id="syncText">Sparad lokalt</span>
      </div>
      <div id="userInfo" style="display:none;" class="user-info">
        <img id="userAvatar" class="user-avatar" alt="User" />
        <span id="userName"></span>
        <button id="signOutBtn" class="ghost" title="Logga ut">Logga ut</button>
      </div>
      <button id="signInBtn" class="secondary" style="display:none;" title="Logga in med Google">
        <span>üîê Logga in</span>
      </button>
    </div>
    <form class="controls" id="addForm" autocomplete="off">
      <input id="taskInput" type="text" placeholder="Rubrik (obligatorisk)" aria-label="Ny uppgift" required />
      <button type="submit" title="L√§gg till i 'Att g√∂ra'">L√§gg till</button>
      <button id="exportBtn" type="button" class="secondary" title="Exportera som JSON">Exportera</button>
      <button id="importBtn" type="button" class="ghost" title="Importera fr√•n JSON">Importera</button>
    </form>
  </header>

  <main>
    <section class="column" data-col="todo" aria-label="Att g√∂ra">
      <div class="col-header">
        <div class="col-title">Att g√∂ra</div>
        <div>
          <button class="icon-btn" data-clear="todo" title="T√∂m kolumn">T√∂m</button>
        </div>
      </div>
      <div class="dropzone" data-col="todo" aria-label="Sl√§pp uppgifter h√§r" aria-dropeffect="move"></div>
    </section>

    <section class="column" data-col="doing" aria-label="P√•g√•r">
      <div class="col-header">
        <div class="col-title">P√•g√•r</div>
        <div>
          <button class="icon-btn" data-clear="doing" title="T√∂m kolumn">T√∂m</button>
        </div>
      </div>
      <div class="dropzone" data-col="doing" aria-label="Sl√§pp uppgifter h√§r" aria-dropeffect="move"></div>
    </section>

    <section class="column" data-col="done" aria-label="Klart">
      <div class="col-header">
        <div class="col-title">Klart</div>
        <div>
          <button class="icon-btn" data-clear="done" title="T√∂m kolumn">T√∂m</button>
        </div>
      </div>
      <div class="dropzone" data-col="done" aria-label="Sl√§pp uppgifter h√§r" aria-dropeffect="move"></div>
    </section>
  </main>

  <footer>
    Tips: Dra & sl√§pp kort mellan kolumner. Dubbelklicka p√• ett kort f√∂r att redigera. Allt sparas automatiskt lokalt och synkas till molnet n√§r du √§r inloggad.
  </footer>


  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCjQLnpI8DOhbZaheiWKDDSCZcHOZIxz4U",
      authDomain: "personal-kanban-ae9b7.firebaseapp.com",
      projectId: "personal-kanban-ae9b7",
      storageBucket: "personal-kanban-ae9b7.firebasestorage.app",
      messagingSenderId: "916501713123",
      appId: "1:916501713123:web:bdf498b9d459ccb2f9f5d6"
    };

    // Initialize Firebase
    let app, auth, db, currentUser = null, unsubscribe = null;
    let syncEnabled = false;

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      syncEnabled = true;
    } catch (e) {
      console.warn('Firebase not configured properly. Using local storage only.', e);
    }

    // Export Firebase functions to global scope
    window.firebaseAuth = {
      signIn: async () => {
        if (!syncEnabled) return alert('Firebase √§r inte konfigurerad. Kontakta administrat√∂ren.');
        const provider = new GoogleAuthProvider();
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error('Sign in error:', error);
          alert('Kunde inte logga in: ' + error.message);
        }
      },
      signOut: async () => {
        if (!syncEnabled) return;
        try {
          if (unsubscribe) unsubscribe();
          await signOut(auth);
        } catch (error) {
          console.error('Sign out error:', error);
        }
      },
      onAuthChange: (callback) => {
        if (!syncEnabled) return;
        onAuthStateChanged(auth, callback);
      },
      syncToFirestore: async (userId, boardTitle, boardData) => {
        if (!syncEnabled || !userId) return;
        try {
          updateSyncStatus('syncing', 'Synkar...');
          await setDoc(doc(db, 'kanban_boards', userId), {
            title: boardTitle,
            board: boardData,
            lastModified: Date.now()
          });
          updateSyncStatus('synced', 'Synkad');
        } catch (error) {
          console.error('Sync error:', error);
          updateSyncStatus('error', 'Synkfel');
        }
      },
      loadFromFirestore: async (userId) => {
        if (!syncEnabled || !userId) return null;
        try {
          const docRef = doc(db, 'kanban_boards', userId);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            return docSnap.data();
          }
          return null;
        } catch (error) {
          console.error('Load error:', error);
          return null;
        }
      },
      listenToChanges: (userId, callback) => {
        if (!syncEnabled || !userId) return null;
        const docRef = doc(db, 'kanban_boards', userId);
        return onSnapshot(docRef, (doc) => {
          if (doc.exists()) {
            callback(doc.data());
          }
        });
      }
    };

    function updateSyncStatus(state, text) {
      const indicator = document.querySelector('.sync-indicator');
      const syncText = document.getElementById('syncText');
      if (indicator && syncText) {
        indicator.className = 'sync-indicator ' + state;
        syncText.textContent = text;
      }
    }

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFirebaseUI);
    } else {
      initFirebaseUI();
    }

    function initFirebaseUI() {
      console.log('Initializing Firebase UI...');
      
      // Show/hide UI elements based on Firebase availability
      if (syncEnabled) {
        const signInBtn = document.getElementById('signInBtn');
        const syncStatus = document.getElementById('syncStatus');
        
        console.log('Firebase enabled, signInBtn:', signInBtn, 'syncStatus:', syncStatus);
        
        if (signInBtn) {
          signInBtn.style.display = 'block';
          signInBtn.addEventListener('click', () => {
            console.log('Sign in button clicked in module!');
            window.firebaseAuth.signIn();
          });
        }
        
        if (syncStatus) {
          syncStatus.style.display = 'flex';
        }

        // Set up auth state listener
        setupAuthStateListener();
      } else {
        console.log('Firebase not enabled');
      }
    }

    function setupAuthStateListener() {
      console.log('Setting up auth state listener...');
      
      onAuthStateChanged(auth, async (user) => {
        console.log('Auth state changed, user:', user);
        
        if (user) {
          // User is signed in
          console.log('User signed in:', user.displayName || user.email);
          
          // Update UI
          const signInBtn = document.getElementById('signInBtn');
          const userInfo = document.getElementById('userInfo');
          const userName = document.getElementById('userName');
          const userAvatar = document.getElementById('userAvatar');
          
          if (signInBtn) signInBtn.style.display = 'none';
          if (userInfo) userInfo.style.display = 'flex';
          if (userName) userName.textContent = user.displayName || user.email;
          if (userAvatar && user.photoURL) userAvatar.src = user.photoURL;

          // Update sync status to show syncing
          updateSyncStatus('syncing', 'Synkar...');

          // Notify main script
          window.dispatchEvent(new CustomEvent('firebaseAuthChanged', { 
            detail: { user, signedIn: true } 
          }));

        } else {
          // User is signed out
          console.log('User signed out');
          
          // Update UI
          const signInBtn = document.getElementById('signInBtn');
          const userInfo = document.getElementById('userInfo');
          
          if (signInBtn) signInBtn.style.display = 'block';
          if (userInfo) userInfo.style.display = 'none';
          
          // Update sync status
          updateSyncStatus('', 'Sparad lokalt');

          // Notify main script
          window.dispatchEvent(new CustomEvent('firebaseAuthChanged', { 
            detail: { user: null, signedIn: false } 
          }));
        }
      });
    }
  </script>

  <script>
    const STORAGE_KEY = 'simple-kanban-v1';

    /** @typedef {{ id:string, headline:string, text:string, created:number }} Task */
    /** @typedef {{ todo: Task[], doing: Task[], done: Task[] }} Board */

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    let currentUserId = null;
    let isSyncing = false;
    let syncUnsubscribe = null;

    /** @returns {Board} */
    function load(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { todo: [], doing: [], done: [] };
        const data = JSON.parse(raw);
        return { todo: data.todo||[], doing: data.doing||[], done: data.done||[] };
      } catch(e){
        console.warn('Kunde inte l√§sa lagring', e); return { todo: [], doing: [], done: [] };
      }
    }
    /** @param {Board} data */
    function save(data){ 
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      localStorage.setItem('lastModified', Date.now().toString());
      // Sync to Firestore if user is logged in
      if (currentUserId && window.firebaseAuth && !isSyncing) {
        window.firebaseAuth.syncToFirestore(currentUserId, loadBoardTitle(), data);
      }
    }

    function loadBoardTitle(){
      return localStorage.getItem('kanban-board-title') || 'Enkel Kanban';
    }
    function saveBoardTitle(title){ 
      localStorage.setItem('kanban-board-title', title);
      // Sync title to Firestore
      if (currentUserId && window.firebaseAuth && !isSyncing) {
        window.firebaseAuth.syncToFirestore(currentUserId, title, board);
      }
    }

    /** @type {Board} */
    let board = load();

    function uid(){ return Math.random().toString(36).slice(2,9); }

    function render(){
      ['todo','doing','done'].forEach(col => {
        const zone = `.dropzone[data-col="${col}"]`;
        const container = document.querySelector(zone);
        container.innerHTML = '';
        board[col].forEach(task => container.appendChild(renderCard(task)));
      });
    }

    function renderCard(task){
      const el = document.createElement('article');
      el.className = 'card';
      el.setAttribute('draggable', 'true');
      el.dataset.id = task.id;

      el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({ id: task.id }));
      });

      const headline = document.createElement('div');
      headline.className = 'headline';
      headline.textContent = task.headline || task.text;

      const text = document.createElement('div');
      text.className = 'text';
      text.textContent = task.text || '';
      if (!task.headline) text.style.display = 'none';

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = new Date(task.created).toLocaleString();

      const left = document.createElement('div');
      left.appendChild(headline); left.appendChild(text); left.appendChild(meta);

      const del = document.createElement('button');
      del.className = 'icon-btn danger';
      del.innerText = 'Ta bort';
      del.title = 'Ta bort uppgift';
      del.addEventListener('click', () => removeTask(task.id));

      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.appendChild(del);

      el.appendChild(left); el.appendChild(actions);

      // Inline-redigering
      el.addEventListener('dblclick', () => startEdit(el, task));

      return el;
    }

    function startEdit(cardEl, task){
      const left = cardEl.querySelector('div');
      const currentHeadline = task.headline || task.text || '';
      const currentText = task.text || '';
      
      const form = document.createElement('div');
      const headlineInput = document.createElement('input');
      headlineInput.type = 'text';
      headlineInput.value = currentHeadline;
      headlineInput.placeholder = 'Rubrik';
      headlineInput.style.width = '100%'; headlineInput.style.background = 'transparent'; 
      headlineInput.style.color = 'inherit'; headlineInput.style.border = '1px solid var(--border)';
      headlineInput.style.borderRadius = '8px'; headlineInput.style.padding = '6px';
      headlineInput.style.marginBottom = '6px'; headlineInput.style.fontWeight = '700';
      
      const textInput = document.createElement('textarea');
      textInput.value = currentText;
      textInput.placeholder = 'Beskrivning (valfri)';
      textInput.rows = Math.min(4, Math.max(2, currentText.split('\n').length));
      textInput.style.width = '100%'; textInput.style.background = 'transparent'; 
      textInput.style.color = 'inherit'; textInput.style.border = '1px solid var(--border)';
      textInput.style.borderRadius = '8px'; textInput.style.padding = '6px';
      
      form.appendChild(headlineInput);
      form.appendChild(textInput);
      left.innerHTML = '';
      left.appendChild(form);
      headlineInput.focus();
      
      const finish = () => {
        const h = headlineInput.value.trim();
        const t = textInput.value.trim();
        if(h){ task.headline = h; task.text = t; save(board); render(); }
        else { removeTask(task.id); }
      };
      headlineInput.addEventListener('blur', (e) => { if(!form.contains(e.relatedTarget)) finish(); });
      textInput.addEventListener('blur', (e) => { if(!form.contains(e.relatedTarget)) finish(); });
      textInput.addEventListener('keydown', e => { if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) finish(); });
    }

    function addTask(headline, text='', column='todo'){
      const task = { id: uid(), headline, text, created: Date.now() };
      board[column].push(task); save(board); render();
    }

    let undoTimeout = null;
    let deletedTask = null;
    let deletedColumn = null;

    function removeTask(id){
      // Save for undo
      ['todo','doing','done'].forEach(col => {
        const i = board[col].findIndex(t => t.id === id);
        if(i>-1) {
          deletedTask = board[col][i];
          deletedColumn = col;
          board[col].splice(i,1);
        }
      });
      save(board); render();
      showUndoToast();
    }

    function showUndoToast() {
      // Remove existing toast if any
      const existing = document.querySelector('.undo-toast');
      if (existing) existing.remove();
      if (undoTimeout) clearTimeout(undoTimeout);

      // Create toast
      const toast = document.createElement('div');
      toast.className = 'undo-toast';
      toast.innerHTML = `
        <span>Uppgift borttagen</span>
        <button id="undoBtn">√Öngra</button>
      `;
      document.body.appendChild(toast);

      // Undo button
      document.getElementById('undoBtn').addEventListener('click', () => {
        if (deletedTask && deletedColumn) {
          board[deletedColumn].push(deletedTask);
          save(board);
          render();
          deletedTask = null;
          deletedColumn = null;
        }
        toast.remove();
        if (undoTimeout) clearTimeout(undoTimeout);
      });

      // Auto-remove after 5 seconds
      undoTimeout = setTimeout(() => {
        toast.remove();
        deletedTask = null;
        deletedColumn = null;
      }, 5000);
    }

    function moveTask(id, toCol){
      if(!['todo','doing','done'].includes(toCol)) return;
      let moving = null, from = null;
      for(const col of ['todo','doing','done']){
        const i = board[col].findIndex(t => t.id===id);
        if(i>-1){ moving = board[col].splice(i,1)[0]; from = col; break; }
      }
      if(moving){ board[toCol].push(moving); save(board); render(); }
    }

    // DnD
    $$('.dropzone').forEach(zone => {
      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', e => {
        e.preventDefault(); zone.classList.remove('dragover');
        try { const { id } = JSON.parse(e.dataTransfer.getData('text/plain')); moveTask(id, zone.dataset.col); }
        catch{}
      });
    });

    // Form
    $('#addForm').addEventListener('submit', e => {
      e.preventDefault(); const v = $('#taskInput').value.trim(); if(!v) return;
      addTask(v, 'todo'); e.target.reset(); $('#taskInput').focus();
    });

    // Mobile menu toggle
    const mobileMenuBtn = $('#mobileMenuBtn');
    const menuDropdown = $('#menuDropdown');
    if (mobileMenuBtn && menuDropdown) {
      mobileMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle('show');
      });

      // Close menu when clicking outside
      document.addEventListener('click', () => {
        menuDropdown.classList.remove('show');
      });

      // Prevent menu from closing when clicking inside
      menuDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // Mobile export button
    $('#exportBtnMobile')?.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(board, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'kanban.json'; a.click(); URL.revokeObjectURL(url);
      menuDropdown?.classList.remove('show');
    });

    // Mobile import button
    $('#importBtnMobile')?.addEventListener('click', async () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files?.[0]; if(!file) return;
        try { const text = await file.text(); const data = JSON.parse(text);
          if(['todo','doing','done'].every(k => Array.isArray(data[k]))){ board = { todo: data.todo, doing: data.doing, done: data.done }; save(board); render(); }
          else alert('Ogiltigt JSON-format');
        } catch { alert('Kunde inte l√§sa filen'); }
      };
      input.click();
      menuDropdown?.classList.remove('show');
    });

    // Clear buttons
    $$('button[data-clear]').forEach(btn => btn.addEventListener('click', () => {
      const col = btn.getAttribute('data-clear');
      if (confirm(`T√∂m kolumnen "${col}"?`)) { board[col] = []; save(board); render(); }
    }));

    // Sign out button
    $('#signOutBtn')?.addEventListener('click', () => {
      if (confirm('Vill du logga ut? Dina uppgifter kommer fortfarande att finnas kvar i molnet.')) {
        if (window.firebaseAuth) {
          window.firebaseAuth.signOut();
        }
      }
    });

    // Editable board title
    const titleEl = $('#boardTitle');
    titleEl.textContent = loadBoardTitle();
    titleEl.addEventListener('click', () => {
      const current = titleEl.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = current;
      input.style.fontSize = '1.4rem';
      input.style.fontWeight = 'inherit';
      input.style.background = 'transparent';
      input.style.color = 'inherit';
      input.style.border = '1px solid var(--border)';
      input.style.borderRadius = '8px';
      input.style.padding = '6px 10px';
      input.style.width = 'max-content';
      input.style.minWidth = '200px';
      titleEl.replaceWith(input);
      input.focus();
      input.select();
      const finish = () => {
        const val = input.value.trim() || 'Enkel Kanban';
        saveBoardTitle(val);
        titleEl.textContent = val;
        document.title = val;
        input.replaceWith(titleEl);
      };
      input.addEventListener('blur', finish);
      input.addEventListener('keydown', e => { if(e.key==='Enter') finish(); if(e.key==='Escape') { titleEl.textContent = current; input.replaceWith(titleEl); } });
    });

    // Export/Import JSON
    $('#exportBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(board, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'kanban.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#importBtn').addEventListener('click', async () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
      input.onchange = async () => {
        const file = input.files?.[0]; if(!file) return;
        try { const text = await file.text(); const data = JSON.parse(text);
          if(['todo','doing','done'].every(k => Array.isArray(data[k]))){ board = { todo: data.todo, doing: data.doing, done: data.done }; save(board); render(); }
          else alert('Ogiltigt JSON-format');
        } catch { alert('Kunde inte l√§sa filen'); }
      };
      input.click();
    });

    // Render initial board (no example tasks - could overwrite cloud data)
    render();

    // Set page title to match board title
    document.title = loadBoardTitle();

    // Firebase Authentication handlers - listen for auth changes from module
    window.addEventListener('firebaseAuthChanged', async (event) => {
      console.log('Auth changed event received:', event.detail);
      const { user, signedIn } = event.detail;

      if (signedIn && user) {
        // User signed in
        currentUserId = user.uid;

        // Load data from Firestore
        if (window.firebaseAuth) {
          const cloudData = await window.firebaseAuth.loadFromFirestore(user.uid);
          if (cloudData) {
            // Cloud data exists - merge with local data
            const localModified = parseInt(localStorage.getItem('lastModified') || '0');
            const hasLocalData = board.todo.length > 0 || board.doing.length > 0 || board.done.length > 0;
            
            if (!hasLocalData || !localModified) {
              // No local data or never modified - use cloud data
              console.log('No local data, using cloud data');
              isSyncing = true;
              board = cloudData.board;
              const newTitle = cloudData.title;
              $('#boardTitle').textContent = newTitle;
              document.title = newTitle;
              saveBoardTitle(newTitle);
              save(board);
              render();
              isSyncing = false;
            } else if (cloudData.lastModified > localModified) {
              // Cloud is newer - use cloud data
              console.log('Cloud data is newer, using cloud data');
              isSyncing = true;
              board = cloudData.board;
              const newTitle = cloudData.title;
              $('#boardTitle').textContent = newTitle;
              document.title = newTitle;
              saveBoardTitle(newTitle);
              save(board);
              render();
              isSyncing = false;
            } else {
              // Local has changes - merge intelligently
              console.log('Merging local and cloud data');
              
              // Create a map of existing tasks by ID from cloud
              const cloudTaskIds = new Set();
              ['todo', 'doing', 'done'].forEach(col => {
                cloudData.board[col].forEach(task => cloudTaskIds.add(task.id));
              });
              
              // Merge: Keep all cloud tasks + add local tasks that don't exist in cloud
              const merged = { todo: [], doing: [], done: [] };
              
              // First, add all cloud tasks
              ['todo', 'doing', 'done'].forEach(col => {
                merged[col] = [...cloudData.board[col]];
              });
              
              // Then, add local tasks that are NOT in cloud (new tasks)
              ['todo', 'doing', 'done'].forEach(col => {
                board[col].forEach(task => {
                  if (!cloudTaskIds.has(task.id)) {
                    // This is a new task created locally, add it
                    merged[col].push(task);
                    console.log(`Adding new local task: ${task.headline}`);
                  }
                });
              });
              
              isSyncing = true;
              board = merged;
              // Keep local title if modified, otherwise use cloud title
              const localTitle = loadBoardTitle();
              if (localTitle !== 'Enkel Kanban' && localTitle !== cloudData.title) {
                $('#boardTitle').textContent = localTitle;
                document.title = localTitle;
              } else {
                $('#boardTitle').textContent = cloudData.title;
                document.title = cloudData.title;
                saveBoardTitle(cloudData.title);
              }
              save(board);
              render();
              
              // Upload merged data to cloud
              await window.firebaseAuth.syncToFirestore(user.uid, loadBoardTitle(), board);
              console.log('Merged data uploaded to cloud');
              isSyncing = false;
            }
          } else {
            // No cloud data exists yet
            // Only upload local data if it's not empty
            const hasLocalData = board.todo.length > 0 || board.doing.length > 0 || board.done.length > 0;
            if (hasLocalData) {
              console.log('No cloud data, uploading local data');
              await window.firebaseAuth.syncToFirestore(user.uid, loadBoardTitle(), board);
            } else {
              console.log('No cloud data and no local data - starting fresh');
            }
          }

          // Listen for real-time updates
          if (syncUnsubscribe) syncUnsubscribe();
          syncUnsubscribe = window.firebaseAuth.listenToChanges(user.uid, (data) => {
            if (!isSyncing && data.lastModified > (parseInt(localStorage.getItem('lastModified') || '0'))) {
              isSyncing = true;
              board = data.board;
              const newTitle = data.title;
              $('#boardTitle').textContent = newTitle;
              document.title = newTitle;
              localStorage.setItem('kanban-board-title', newTitle);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(data.board));
              localStorage.setItem('lastModified', data.lastModified.toString());
              render();
              setTimeout(() => { isSyncing = false; }, 500);
            }
          });
        }
      } else {
        // User signed out
        currentUserId = null;
        if (syncUnsubscribe) syncUnsubscribe();
      }
    });
  </script>
</body>
</html>
